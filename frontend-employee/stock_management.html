<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>จัดการสต็อก | ระบบจัดการงานซ่อม</title>
    <link rel="icon" type="image/png" href="logo1.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* === 1. Variables & Global Reset === */
        :root {
            --primary-color: #34495e; /* Midnight Blue */
            --secondary-color: #2ecc71; /* Emerald Green (เน้นความสำเร็จ) */
            --accent-color: #3498db; /* Bright Blue */
            --background-color: #f4f6f9; /* Light Gray Background */
            --card-background: #ffffff;
            --text-color: #2c3e50;
            --light-text-color: #7f8c8d;
            --border-radius: 12px;
            --box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            --danger-color: #e74c3c;
            --warning-color: #f39c12; 
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Kanit', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            line-height: 1.6;
        }

        .container {
            max-width: 1300px;
            margin: 0 auto;
            padding: 20px;
        }

        /* === 2. Header & Navigation === */
        header {
            background-color: var(--primary-color);
            color: #ffffff;
            padding: 15px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--box-shadow);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-links {
            display: flex;
            gap: 25px;
        }

        .nav-link {
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            font-weight: 500;
            font-size: 0.95rem;
            transition: color 0.3s ease, border-bottom 0.3s;
            padding: 5px 0;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .nav-link:hover {
            color: #ffffff;
            border-bottom: 2px solid var(--accent-color);
        }
        
        .nav-link.active {
            color: #ffffff;
            border-bottom: 3px solid var(--secondary-color);
            font-weight: 600;
        }

        /* === 3. Main Content Layout & Controls (FLexbox) === */
        .content-section {
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--box-shadow);
            margin-top: 20px;
        }
        
        .section-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 25px;
            border-left: 5px solid var(--secondary-color);
            padding-left: 15px;
        }

        .stock-controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            margin-bottom: 25px;
            padding: 15px;
            background-color: #ecf0f1; 
            border-radius: 10px;
            border: 1px solid #ddd;
        }
        
        .search-box {
            position: relative;
            flex-grow: 1;
            max-width: 350px;
            min-width: 200px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 15px 12px 40px;
            border: 1px solid #ccc;
            border-radius: 50px;
            font-size: 1rem;
            transition: all 0.3s;
            font-family: 'Kanit', sans-serif;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 8px rgba(52, 152, 219, 0.4);
        }

        .search-box .fa-search {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--light-text-color);
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
            color: var(--primary-color);
        }

        .filter-group select {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-family: 'Kanit', sans-serif;
            min-width: 150px;
            cursor: pointer;
        }

        .btn {
            background-color: var(--accent-color);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s;
            text-decoration: none;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 10px rgba(52, 152, 219, 0.3);
        }
        
        .btn-withdraw { 
            background-color: var(--warning-color);
            box-shadow: 0 4px 10px rgba(243, 156, 18, 0.3);
        }
        .btn-withdraw:hover {
            background-color: #e67e22;
        }

        .btn:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(52, 152, 219, 0.4);
        }

        /* === 4. Table Styling (Emphasis on Clarity) === */
        .table-responsive {
            overflow-x: auto;
        }

        .styled-table {
            width: 100%;
            border-collapse: separate; 
            border-spacing: 0 8px; 
            font-size: 0.95rem;
        }

        .styled-table thead tr {
            background-color: var(--primary-color);
            color: white;
            text-align: left;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .styled-table th {
            padding: 15px 20px;
            font-weight: 600;
        }
        .styled-table thead th:first-child { border-top-left-radius: 10px; }
        .styled-table thead th:last-child { border-top-right-radius: 10px; }

        .styled-table td {
            padding: 15px 20px;
            background-color: var(--card-background);
            border-bottom: 1px solid #ecf0f1;
            vertical-align: middle;
        }

        .styled-table tbody tr {
            transition: transform 0.2s, box-shadow 0.2s;
            border-radius: 10px;
        }
        .styled-table tbody tr:hover {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-3px);
            cursor: pointer;
        }
        
        .styled-table tbody tr td:first-child { border-left: 5px solid #bdc3c7; border-top-left-radius: 10px; border-bottom-left-radius: 10px; }
        .styled-table tbody tr:hover td:first-child { border-left-color: var(--accent-color); }
        .styled-table tbody tr td:last-child { border-top-right-radius: 10px; border-bottom-right-radius: 10px; }

        .low-stock {
            color: var(--danger-color);
            font-weight: 700;
            background-color: #fcebe9;
            padding: 5px 10px;
            border-radius: 5px;
            display: inline-block;
        }
        
        .out-of-stock {
            color: var(--danger-color);
            font-weight: 700;
        }

        .action-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .action-link {
            color: var(--accent-color);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
        }
        
        .action-btn-withdraw {
            background-color: var(--warning-color);
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-family: 'Kanit', sans-serif;
            transition: background-color 0.3s;
            font-weight: 500;
        }
        .action-btn-withdraw:hover {
            background-color: #e67e22;
        }

        /* === 5. Modal Styling (Clean & Modern) === */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            overflow: auto;
            padding-top: 60px;
        }
        
        .modal-content {
            background-color: var(--card-background);
            margin: 5% auto;
            padding: 40px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 450px;
            box-shadow: var(--box-shadow);
            animation: fadeIn 0.4s ease-out;
            position: relative;
        }
        
        .close-btn {
            color: var(--light-text-color);
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 30px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close-btn:hover {
            color: var(--danger-color);
        }

        .modal-content h2 {
            font-size: 1.8rem;
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 25px;
            text-align: center;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        .modal-content form label {
            display: block;
            margin-top: 15px;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 5px;
        }

        .modal-content form input,
        .modal-content form select {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-family: 'Kanit', sans-serif;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        .modal-content form input:focus {
            border-color: var(--secondary-color);
            outline: none;
            box-shadow: 0 0 5px rgba(46, 204, 113, 0.5);
        }

        .modal-content p strong {
            color: var(--secondary-color);
            font-weight: 700;
            font-size: 1.1rem;
        }

        .modal-content form button {
            width: 100%;
            margin-top: 30px;
            padding: 15px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* === 6. Media Queries (Responsive) === */
        @media (max-width: 992px) {
            .stock-controls {
                flex-direction: column;
                align-items: stretch;
            }
            .search-box {
                max-width: none;
                order: 1;
            }
            .filter-group {
                order: 2;
                justify-content: space-between;
                width: 100%;
            }
            #addStockBtn {
                order: 3;
                width: 100%;
            }
        }
        
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                padding: 15px;
            }
            .nav-links {
                flex-wrap: wrap;
                justify-content: center;
                margin-top: 15px;
            }
            .content-section {
                padding: 20px;
            }
            .styled-table th, .styled-table td {
                padding: 12px 10px;
            }
        }
    .content-section{
  background:#fff;
  border-radius:14px;
  padding:30px;
  box-shadow:0 10px 30px rgba(0,0,0,.06);
  margin-bottom:30px;
}

.section-title{
  display:flex;
  align-items:center;
  gap:12px;
  font-size:1.6rem;
  font-weight:600;
  color:#1f3a4d;
  margin-bottom:20px;
}

.section-line{
  width:4px;
  height:28px;
  background:#22c55e;
  border-radius:4px;
}

.styled-table{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
}

.styled-table thead{
  background:#2c3e50;
  color:#fff;
}

.styled-table th,
.styled-table td{
  padding:14px 16px;
  text-align:left;
}

.styled-table tbody tr{
  background:#fff;
  border-bottom:1px solid #edf2f7;
}

.styled-table tbody tr:hover{
  background:#f9fafb;
}
.filter-bar{
  display:flex;
  align-items:center;
  gap:16px;
  background:#eef2f3;
  padding:16px;
  border-radius:12px;
  margin-bottom:20px;
}

.filter-left{
  display:flex;
  align-items:center;
  gap:8px;
}

.filter-center{
  flex:1;
  display:flex;
  align-items:center;
  gap:8px;
  background:#fff;
  padding:10px 14px;
  border-radius:999px;
}

.filter-center input{
  border:none;
  outline:none;
  width:100%;
  font-size:0.95rem;
}
.filter-left select{
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;

  padding: 8px 36px 8px 12px;
  border-radius: 8px;
  border: 1px solid #d1d5db;
  background-color: #fff;
  font-size: 0.9rem;
  cursor: pointer;

  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' fill='gray' viewBox='0 0 20 20'%3E%3Cpath d='M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 10px center;
}

    </style>
</head>
<body>
    <header>
        <h1 class="logo">
            <i class="fas fa-tools"></i> ระบบจัดการงานซ่อม
        </h1>
        <nav class="nav-links">
            <a href="employee_dashboard.html" class="nav-link"><i class="fas fa-home"></i> หน้าหลัก</a>
            <a href="new_job.html" class="nav-link"><i class="fas fa-plus-circle"></i> รับเครื่องซ่อม</a>
            <a href="stock_management.html" class="nav-link active"><i class="fas fa-box-open"></i> จัดการสต็อก</a>
            <a href="technician_jobs.html" class="nav-link"><i class="fas fa-tools"></i> งานของฉัน</a>
            <a href="reports.html" class="nav-link" id="reports-link"><i class="fas fa-chart-line"></i> รายงาน</a>
        </nav>
    </header>
    
    <main class="container">
        <div class="content-section">
            <h2 class="section-title">รายการอะไหล่ในสต็อก</h2>
            
            <div class="stock-controls">
                <div class="filter-group">
                    <label for="typeFilter"><i class="fas fa-filter"></i> กรองตามประเภท:</label>
                    <select id="typeFilter" onchange="filterStock()">
                        <option value="all">ทั้งหมด</option>
                    </select>
                </div>
                
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" onkeyup="filterStock()" placeholder="ค้นหา ID, ชื่อ, รุ่นอะไหล่...">
                </div>
                
                <button id="addStockBtn" class="btn">
                    <i class="fas fa-plus-square"></i> เพิ่มอะไหล่ใหม่
                </button>
            </div>

            <div class="table-responsive bg-white rounded-xl shadow-lg overflow-x-auto">
                <table class="styled-table" id="stockTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>ชื่ออะไหล่</th>
                            <th>ประเภท</th>
                            <th>ยี่ห้อ/รุ่น</th>
                            <th>จำนวนคงเหลือ</th>
                            <th>ราคา</th>
                            <th>การจัดการ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>
<!-- ===============================
     ประวัติการเบิกอะไหล่
=============================== -->
<div class="content-section" style="margin-top:30px;">
  <h2 class="section-title">
    <span class="section-line"></span>
    ประวัติการเบิกอะไหล่
  </h2>

  <!-- FILTER BAR -->
  <div class="filter-bar">
    <div class="filter-left">
      <i class="fas fa-filter"></i>
      <label>กรองตามอะไหล่:</label>
      <select id="withdrawFilter">
        <option value="">ทั้งหมด</option>
      </select>
    </div>

    <div class="filter-center">
      <i class="fas fa-search"></i>
      <input
        type="text"
        id="withdrawSearch"
        placeholder="ค้นหา อะไหล่, รุ่น, ผู้เบิก, งาน..."
      />
    </div>
  </div>

  <!-- TABLE -->
  <div style="overflow-x:auto;">
    <table class="styled-table" id="withdrawHistoryTable">
      <thead>
        <tr>
          <th>อะไหล่</th>
          <th>รุ่น</th>
          <th>จำนวน</th>
          <th>ผู้เบิก</th>
          <th>อ้างอิงงาน</th>
          <th>วันที่เบิก</th>
        </tr>
      </thead>
      <tbody>
        <!-- JS เติม -->
      </tbody>
    </table>
  </div>
</div>


    <!-- Stock Modal -->
    <div id="stockModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" data-modal="stockModal">&times;</span>
            <h2 id="modalTitle" class="text-2xl font-bold text-emerald-600 mb-6 border-b pb-2">เพิ่มอะไหล่ใหม่</h2>
            <form id="stockForm" class="space-y-4">
                <input type="hidden" id="stockId" name="stockId">
                <div>
                    <label for="itemStockCode">รหัสอะไหล่:</label>
                    <input type="text" id="itemStockCode" name="itemStockCode" required placeholder="เช่น CPU-001, BAT-002">
                </div>

                <div>
                    <label for="itemName" class="block font-medium text-gray-700">ชื่ออะไหล่:</label>
                    <input type="text" id="itemName" name="itemName" required class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                </div>

                <div>
                    <label for="itemType" class="block font-medium text-gray-700">ประเภท:</label>
                    <input type="text" id="itemType" name="itemType" required class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                </div>

                <div>
                    <label for="itemModel" class="block font-medium text-gray-700">ยี่ห้อ/รุ่น:</label>
                    <input type="text" id="itemModel" name="itemModel" required class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                </div>

                <div>
                    <label for="itemQuantity" class="block font-medium text-gray-700">จำนวนคงเหลือ:</label>
                    <input type="number" id="itemQuantity" name="itemQuantity" required min="0" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                </div>

                <div>
                    <label for="itemPrice" class="block font-medium text-gray-700">ราคา:</label>
                    <input type="number" id="itemPrice" name="itemPrice" required min="0" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                </div>

                <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-xl transition duration-300 shadow-lg mt-6">
                    <i class="fas fa-save"></i> <span id="saveButtonText">บันทึกข้อมูล</span>
                </button>
            </form>
        </div>
    </div>

    <!-- Withdraw Modal -->
    <div id="withdrawModal" class="modal">
        <div class="modal-content !max-w-[450px]">
            <span class="close-btn" data-modal="withdrawModal">&times;</span>
            <h2 class="text-2xl font-bold text-orange-600 mb-6 border-b pb-2 flex items-center">
                <i class="fas fa-dolly-flatbed mr-2"></i> เบิกอะไหล่
            </h2>
           <form id="withdrawForm" class="space-y-4">

  <!-- hidden -->
  <input type="hidden" id="withdrawStockId">
  <input type="hidden" id="maxQuantity">

  <!-- กล่องข้อมูลอะไหล่ -->
  <div class="bg-gray-100 p-4 rounded-lg border border-gray-200">
    <div class="text-sm text-gray-600 mb-1">
      อะไหล่
    </div>
    <div class="text-lg font-semibold text-emerald-700" id="withdrawItemName">
      -
    </div>

    <div class="text-sm text-gray-600 mt-2">
      คงเหลือปัจจุบัน:
      <strong id="currentQuantity" class="text-gray-800">0</strong> ชิ้น
    </div>
  </div>

  <!-- ผู้เบิก -->
  <div>
    <label for="withdrawEmployeeName" class="block font-medium text-gray-700">
      ผู้เบิก
    </label>
    <input
      type="text"
      id="withdrawEmployeeName"
      required
      placeholder="ชื่อ-นามสกุล"
      class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500"
    >
  </div>

  <!-- จำนวน -->
  <div>
    <label for="withdrawQuantity" class="block font-medium text-gray-700">
      จำนวนที่เบิก
    </label>
    <input
      type="number"
      id="withdrawQuantity"
      required
      min="1"
      value="1"
      class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500"
    >
    <p id="withdrawError" class="text-red-500 text-sm mt-1 hidden">
      จำนวนที่เบิกต้องไม่เกินจำนวนคงเหลือ
    </p>
  </div>

  <!-- อ้างอิงงาน -->
  <div>
    <label for="withdrawJobId" class="block font-medium text-gray-700">
      อ้างอิงงาน
    </label>
    <input
      type="text"
      id="withdrawJobId"
      placeholder="เช่น JOB001"
      class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500"
    >
  </div>

  <!-- วันที่เบิก -->
  <div>
    <label for="withdrawDate" class="block font-medium text-gray-700">
      วันที่เบิก
    </label>
    <input
      type="datetime-local"
      id="withdrawDate"
      class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500"
    >
    <p class="text-xs text-gray-500 mt-1">
      * หากไม่เลือก ระบบจะใช้เวลาปัจจุบัน
    </p>
  </div>

  <!-- ปุ่ม -->
  <button
    type="submit"
    class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded-xl transition duration-300 shadow-lg mt-6"
  >
    <i class="fas fa-save mr-1"></i> บันทึกการเบิก
  </button>

</form>


<script>
/* ==========================================================
   stock_management.html — PRODUCTION READY
========================================================== */

const API_BASE = "/api";
const token = localStorage.getItem("token");

/* ================= AUTH ================= */
if (!token) {
  alert("กรุณาเข้าสู่ระบบใหม่");
  location.replace("login.html");
}

/* ================= DOM ================= */
const tableBody = document.querySelector("#stockTable tbody");
const typeFilterSelect = document.getElementById("typeFilter");
const searchInput = document.getElementById("searchInput");

const stockModal = document.getElementById("stockModal");
const withdrawModal = document.getElementById("withdrawModal");

const stockForm = document.getElementById("stockForm");
const withdrawForm = document.getElementById("withdrawForm");

const modalTitle = document.getElementById("modalTitle");
const stockIdInput = document.getElementById("stockId");
const itemNameInput = document.getElementById("itemName");
const itemTypeInput = document.getElementById("itemType");
const itemModelInput = document.getElementById("itemModel");
const itemQuantityInput = document.getElementById("itemQuantity");
const itemPriceInput = document.getElementById("itemPrice");
const itemStockCodeInput = document.getElementById("itemStockCode");

const withdrawStockIdInput = document.getElementById("withdrawStockId");
const withdrawItemNameDisplay = document.getElementById("withdrawItemName");
const currentQuantityDisplay = document.getElementById("currentQuantity");
const withdrawEmployeeNameInput = document.getElementById("withdrawEmployeeName");
const withdrawQuantityInput = document.getElementById("withdrawQuantity");
const withdrawJobIdInput = document.getElementById("withdrawJobId");

let stockData = [];

/* ================= API FETCH ================= */
async function apiFetch(path, options = {}) {
  const res = await fetch(`${API_BASE}${path}`, {
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${token}`
    },
    ...options
  });

  if (res.status === 401 || res.status === 403) {
    alert("Session หมดอายุ กรุณาเข้าสู่ระบบใหม่");
    localStorage.clear();
    location.replace("login.html");
    return [];
  }

  return res.ok ? res.json() : [];
}

/* ================= LOAD STOCK ================= */
async function loadStock() {
  try {
    stockData = await apiFetch("/stocks");
    renderStock(stockData);
    populateTypeFilter();
  } catch {
    alert("❌ โหลดข้อมูลสต็อกไม่สำเร็จ");
  }
    renderWithdrawHistory(); 
    renderWithdrawFilter(stockData);
}

/* ================= RENDER ================= */
function renderStock(data) {
  tableBody.innerHTML = "";

  data.forEach(item => {
    let qtyClass = "";
    if (item.quantity === 0) qtyClass = "low-stock out-of-stock";
    else if (item.quantity <= 3) qtyClass = "low-stock";

    const priceText = item.price != null
      ? item.price.toLocaleString("th-TH") + " ฿"
      : "-";

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${item.stockCode || "-"}</td>
      <td>${item.name}</td>
      <td>${item.type}</td>
      <td>${item.model}</td>
      <td class="${qtyClass}">${item.quantity}</td>
      <td>${priceText}</td>
      <td>
        <div class="action-group">
          <button class="action-btn-withdraw"
            onclick="openWithdrawModal('${item._id}')"
            ${item.quantity === 0 ? "disabled" : ""}>
            เบิก
          </button>
          <a href="#" onclick="openEditModal('${item._id}');return false;">แก้ไข</a>
          <a href="#" style="color:#e74c3c"
            onclick="deleteStock('${item._id}');return false;">ลบ</a>
        </div>
      </td>
    `;
    tableBody.appendChild(tr);
  });
}

/* ================= FILTER ================= */
function filterStock() {
  const txt = searchInput.value.toLowerCase();
  const type = typeFilterSelect.value;

  const filtered = stockData.filter(i =>
    Object.values(i).some(v => String(v).toLowerCase().includes(txt)) &&
    (type === "all" || i.type === type)
  );
  renderStock(filtered);
}

function populateTypeFilter() {
  const types = [...new Set(stockData.map(i => i.type))];
  typeFilterSelect.innerHTML = `<option value="all">ทั้งหมด</option>`;
  types.forEach(t => {
    const opt = document.createElement("option");
    opt.value = t;
    opt.textContent = t;
    typeFilterSelect.appendChild(opt);
  });
}

/* ================= ADD / EDIT ================= */
document.getElementById("addStockBtn").onclick = () => {
  stockForm.reset();
  stockIdInput.value = "";
  modalTitle.textContent = "เพิ่มอะไหล่ใหม่";
  stockModal.style.display = "block";
};

function openEditModal(id) {
  const item = stockData.find(i => i._id === id);
  if (!item) return;

  modalTitle.textContent = "แก้ไขอะไหล่";
  stockIdInput.value = item._id;
  itemStockCodeInput.value = item.stockCode || "";
  itemNameInput.value = item.name;
  itemTypeInput.value = item.type;
  itemModelInput.value = item.model;
  itemQuantityInput.value = item.quantity;
  itemPriceInput.value = item.price || 0;

  stockModal.style.display = "block";
}

stockForm.onsubmit = async e => {
  e.preventDefault();

  const body = {
    stockCode: itemStockCodeInput.value.trim(),
    name: itemNameInput.value.trim(),
    type: itemTypeInput.value.trim(),
    model: itemModelInput.value.trim(),
    quantity: Number(itemQuantityInput.value),
    price: Number(itemPriceInput.value)
  };

  const id = stockIdInput.value;
  const method = id ? "PUT" : "POST";
  const path = id ? `/stocks/${id}` : "/stocks";

  const res = await apiFetch(path, {
    method,
    body: JSON.stringify(body)
  });

  if (res) {
    alert("✅ บันทึกสำเร็จ");
    stockModal.style.display = "none";
    loadStock();
  }
};

/* ================= DELETE ================= */
async function deleteStock(id) {
  if (!confirm("ยืนยันลบอะไหล่นี้?")) return;
  await apiFetch(`/stocks/${id}`, { method: "DELETE" });
  alert("ลบเรียบร้อย");
  loadStock();
}

/* ================= WITHDRAW ================= */
function openWithdrawModal(id) {
  const item = stockData.find(i => i._id === id);
  if (!item) return;

  withdrawStockIdInput.value = id;
  withdrawItemNameDisplay.textContent = item.name;
  currentQuantityDisplay.textContent = item.quantity;
  withdrawQuantityInput.max = item.quantity;
  withdrawQuantityInput.value = 1;

  withdrawModal.style.display = "block";
}

withdrawForm.onsubmit = async e => {
  e.preventDefault();

  const id = withdrawStockIdInput.value;
  const qty = Number(withdrawQuantityInput.value);

  await apiFetch(`/stocks/${id}/withdraw`, {
    method: "PATCH",
    body: JSON.stringify({
      quantity: qty,
      employeeName: withdrawEmployeeNameInput.value,
      jobRef: withdrawJobIdInput.value
    })
  });

  alert("✅ เบิกสำเร็จ");
  withdrawModal.style.display = "none";
  loadStock();
};

/* ================= INIT ================= */
document.addEventListener("DOMContentLoaded", () => {
  loadStock();
  searchInput.addEventListener("keyup", filterStock);
  typeFilterSelect.addEventListener("change", filterStock);
});
/* ================= MODAL CLOSE ================= */
document.querySelectorAll(".close-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    const modalId = btn.getAttribute("data-modal");
    const modal = document.getElementById(modalId);
    if (modal) modal.style.display = "none";
  });
});

/* ปิด modal เมื่อคลิกพื้นหลัง */
window.addEventListener("click", e => {
  if (e.target.classList.contains("modal")) {
    e.target.style.display = "none";
  }
});

function renderWithdrawHistory() {
  const tbody = document.querySelector("#withdrawHistoryTable tbody");
  if (!tbody) return;

  tbody.innerHTML = "";

  stockData.forEach(stock => {

    if (filterType && stock.name !== filterType) return;

    if (!stock.withdrawHistory || !stock.withdrawHistory.length) return;

    stock.withdrawHistory.forEach(h => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${stock.name}</td>
        <td>${stock.model}</td>
        <td>${h.quantity}</td>
        <td>${h.employeeName || "-"}</td>
        <td>${h.jobRef || "-"}</td>
        <td>${new Date(h.withdrawnAt).toLocaleString("th-TH")}</td>
      `;
      tbody.appendChild(tr);
      hasRow = true;
    });
  });

  if (!tbody.innerHTML) {
    tbody.innerHTML = `
      <tr>
        <td colspan="6" style="text-align:center;color:#9ca3af;">
          ยังไม่มีประวัติการเบิกอะไหล่
        </td>
      </tr>
    `;
  }
}
function renderWithdrawFilter(stockData = []) {
  const filter = document.getElementById("withdrawFilter");
  if (!filter) return;

  const typeSet = new Set();

  stockData.forEach(stock => {
    if (stock.withdrawHistory?.length) {
      typeSet.add(stock.name);
    }
  });

  filter.innerHTML = `<option value="">ทั้งหมด</option>`;

  [...typeSet].sort().forEach(type => {
    filter.innerHTML += `
      <option value="${type}">${type}</option>
    `;
  });
}


const withdrawnAt = document.getElementById("withdrawDate").value;

const payload = {
  quantity: Number(withdrawQuantity.value),
  employeeName: withdrawEmployeeName.value,
  jobRef: withdrawJobId.value || null,
  withdrawnAt: withdrawnAt ? new Date(withdrawnAt) : new Date()
};
function initWithdrawFilter() {
  const select = document.getElementById("withdrawFilterName");
  if (!select) return;

  const names = [...new Set(stockData.map(s => s.name))];

  names.forEach(name => {
    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent = name;
    select.appendChild(opt);
  });
}


</script>

</body>
</html>