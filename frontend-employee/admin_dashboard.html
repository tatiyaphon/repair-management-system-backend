<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ผู้ดูแลระบบ | ระบบจัดการงานซ่อม</title>
  <link rel="icon" type="image/png" href="logo1.png">
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap"
    rel="stylesheet">

  <!-- Font Awesome -->
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    rel="stylesheet">

  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #1abc9c;
      --accent-color: #3498db;
      --background-color: #f4f7f9;
      --card-background: #fff;
      --text-color: #2c3e50;
      --light-text-color: #95a5a6;
      --border-radius: 12px;
      --box-shadow: 0 8px 25px rgba(0, 0, 0, .08);

      --new-color: #3498db;
      --in_progress-color: #f39c12;
      --waiting_parts-color: #e74c3c;
      --completed-color: #2ecc71;

      --claim-color: #9b59b6;
      --new-repair-color: #2c3e50;
    }

    * { box-sizing: border-box; }

    body {
      font-family: 'Kanit', sans-serif;
      background: var(--background-color);
      color: var(--text-color);
      margin: 0;
      line-height: 1.6;
    }

    .container {
      max-width: 1300px;
      margin: 0 auto;
      padding: 30px 20px;
    }

    /* Header */
    header {
      background: var(--primary-color);
      color: #fff;
      padding: 15px 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 15px rgba(0, 0, 0, .15);
    }

    .logo {
      font-size: 1.5rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .nav-links {
      margin-left: auto;   /* ดันเมนูไปชิดขวา */
  display: flex;
  gap: 20px;
  align-items: center;
    }

    .nav-link {
      color: rgba(255, 255, 255, .7);
      text-decoration: none;
      font-weight: 500;
      transition: .3s;
      display: flex;
      align-items: center;
      padding-bottom: 4px;
    }

    .nav-link i { margin-right: 5px; }

    .nav-link:hover { color: #fff; }

    .nav-link.active {
      color: #fff;
      border-bottom: 3px solid var(--secondary-color);
    }

    .logout-btn {
      border: 1px solid var(--secondary-color);
      color: var(--secondary-color);
      background: #fff;
      padding: 8px 16px;
      border-radius: 50px;
      font-weight: 600;
      transition: .3s;
    }

    .logout-btn:hover {
      background: var(--secondary-color);
      color: #fff;
    }

    .user-meta {
      font-size: .9rem;
      color: rgba(255, 255, 255, .8);
      margin-left: 20px;
    }

    /* Dashboard header */
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 20px;
      margin-bottom: 25px;
    }

    .page-title {
      margin: 0;
      font-size: 1.9rem;
      font-weight: 700;
      color: var(--primary-color);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .page-subtitle {
      margin: 4px 0 0;
      font-size: .95rem;
      color: var(--light-text-color);
    }

    .tag-admin {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(26, 188, 156, .08);
      color: var(--secondary-color);
      padding: 6px 12px;
      border-radius: 999px;
      font-size: .85rem;
      font-weight: 600;
    }

    /* Cards */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }

    .card {
      background: var(--card-background);
      border-radius: var(--border-radius);
      padding: 20px 22px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, .06);
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: .25s;
      border-left: 5px solid;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, .12);
    }

    .card-content {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .card-title {
      font-size: .9rem;
      color: var(--light-text-color);
      font-weight: 500;
      margin: 0;
    }

    .card-number {
      font-size: 2.4rem;
      font-weight: 700;
      margin: 0;
    }

    .card-note {
      font-size: .8rem;
      color: var(--light-text-color);
    }

    .card-icon {
      font-size: 2.5rem;
      opacity: .2;
    }

    .card-total      { border-left-color: var(--primary-color); }
    .card-new        { border-left-color: var(--new-color); }
    .card-progress   { border-left-color: var(--in_progress-color); }
    .card-completed  { border-left-color: var(--completed-color); }
    .card-users      { border-left-color: var(--accent-color); }

    .card-total .card-number     { color: var(--primary-color); }
    .card-new .card-number       { color: var(--new-color); }
    .card-progress .card-number  { color: var(--in_progress-color); }
    .card-completed .card-number { color: var(--completed-color); }
    .card-users .card-number     { color: var(--accent-color); }

    /* Layout: 2 panels */
    .grid-2col {
      display: grid;
      grid-template-columns: 1.2fr 1fr;
      gap: 25px;
      align-items: flex-start;
    }

    .panel {
      background: var(--card-background);
      border-radius: var(--border-radius);
      padding: 24px;
      box-shadow: var(--box-shadow);
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }

    .panel-title {
      margin: 0;
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--primary-color);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .panel-subtitle {
      margin: 0;
      font-size: .85rem;
      color: var(--light-text-color);
    }

    .badge-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: .8rem;
      background: #ecf0f1;
      color: var(--text-color);
    }

    .badge-pill i { font-size: .8rem; }

    /* Table */
    .table-wrapper {
      overflow-x: auto;
    }

    .styled-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 8px;
      font-size: .9rem;
    }

    .styled-table thead tr {
      background: var(--primary-color);
      color: #fff;
    }

    .styled-table th,
    .styled-table td {
      padding: 10px 12px;
      vertical-align: middle;
    }

    .styled-table tbody tr {
      background: #fff;
      box-shadow: 0 2px 4px rgba(0, 0, 0, .04);
      transition: .2s;
    }

    .styled-table tbody tr:hover {
      background: #fcfdfe;
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0, 0, 0, .08);
    }

    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      color: #fff;
      font-weight: 600;
      font-size: .75rem;
      min-width: 90px;
      text-align: center;
    }

    .status-new          { background: var(--new-color); }
    .status-in_progress  { background: var(--in_progress-color); }
    .status-waiting_parts{ background: var(--waiting_parts-color); }
    .status-completed    { background: var(--completed-color); }

    .role-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: .75rem;
      font-weight: 600;
    }

    .role-admin   { background: rgba(231, 76, 60, .12); color: #e74c3c; }
    .role-tech    { background: rgba(52, 152, 219, .12); color: #2980b9; }
    .role-staff   { background: rgba(46, 204, 113, .12); color: #27ae60; }

    .role-select {
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid #dcdde1;
      font-family: 'Kanit', sans-serif;
      font-size: .85rem;
      background: #fff;
    }

    .btn-small {
      border: none;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: .8rem;
      cursor: pointer;
      font-family: 'Kanit', sans-serif;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      transition: .2s;
    }

    .btn-save {
      background: var(--secondary-color);
      color: #fff;
    }
    .btn-save:hover {
      background: #16a085;
      transform: translateY(-1px);
    }

    .btn-delete {
      background: #ecf0f1;
      color: #e74c3c;
    }
    .btn-delete:hover {
      background: #e74c3c;
      color: #fff;
    }

    .empty-text {
      text-align: center;
      font-size: .9rem;
      color: var(--light-text-color);
      padding: 8px 0;
    }

    /* Add user form */
    .add-user-form {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 15px;
      align-items: center;
    }

    .add-user-form input,
    .add-user-form select {
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid #dcdde1;
      font-family: 'Kanit', sans-serif;
      font-size: .85rem;
    }

    .add-user-form input {
      flex: 1 1 120px;
      min-width: 0;
    }

    .btn-add-user {
      border: none;
      border-radius: 999px;
      padding: 7px 14px;
      font-size: .8rem;
      cursor: pointer;
      font-family: 'Kanit', sans-serif;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      background: var(--accent-color);
      color: #fff;
      white-space: nowrap;
    }

    .btn-add-user:hover {
      background: #2471a3;
      transform: translateY(-1px);
    }

    /* Logs panel */
    .logs-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }

    .panel-filter-text {
      font-size: .85rem;
      color: var(--light-text-color);
    }

    .log-type-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      border-radius: 999px;
      font-size: .7rem;
      padding: 3px 8px;
      color: #fff;
    }

    .log-user   { background: #8e44ad; }
    .log-job    { background: #2980b9; }
    .log-auth   { background: #16a085; }

    .logs-table td {
      font-size: .85rem;
    }

    @media (max-width: 992px) {
      header {
        flex-direction: column;
        align-items: flex-start;
        padding: 15px 20px;
        gap: 8px;
      }

      .nav-links {
        flex-wrap: wrap;
        justify-content: flex-start;
      }

      .user-meta { margin-left: 0; }

      .grid-2col {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 576px) {
  .profile-dropdown {
    position: fixed;
    top: 70px;              /* ใต้ header */
    right: 12px;
    left: 12px;             /* กันล้นซ้าย */
    width: auto;            /* ไม่ fix 260px */
    max-width: 100%;
    border-radius: 12px;
  }

      .panel {
        padding: 18px;
      }
    }
    /* ===== User Management UX ===== */

.add-user-card {
  background: #f9fbfc;
  border: 1px solid #e5e9f0;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 18px;
}

.add-user-card h3 {
  margin: 0 0 12px;
  font-size: 1rem;
  font-weight: 600;
  color: var(--primary-color);
  display: flex;
  align-items: center;
  gap: 8px;
}

.add-user-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
}

.add-user-grid input,
.add-user-grid select {
  padding: 8px 10px;
  border-radius: 8px;
  border: 1px solid #dcdde1;
  font-family: 'Kanit', sans-serif;
  font-size: .9rem;
}

.add-user-grid button {
  grid-column: 1 / -1;
  justify-self: flex-start;
}

.hint-text {
  margin-top: 8px;
  font-size: .8rem;
  color: var(--light-text-color);
}

/* Role badges */
.role-badge {
  padding: 4px 10px;
  border-radius: 999px;
  font-size: .75rem;
  font-weight: 600;
  display: inline-flex;
  align-items: center;
}

.role-admin {
  background: rgba(231, 76, 60, .15);
  color: #e74c3c;
}
.role-tech {
  background: rgba(52, 152, 219, .15);
  color: #2980b9;
}
.role-staff {
  background: rgba(46, 204, 113, .15);
  color: #27ae60;
}
.users-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0 10px;
  }
  .profile-menu {
  position: relative;
  z-index: 99999;
}

.profile-trigger {
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  background: #fff;
  color: #2c3e50;
  padding: 6px 14px;
  border-radius: 30px;
  font-weight: 600;
}

.profile-trigger img {
  width: 34px;
  height: 34px;
  border-radius: 50%;
  object-fit: cover;
}

.profile-dropdown {
  position: absolute;
  right: 0;
  top: 120%;
  width: 260px;
  background: #fff;
  border-radius: 14px;
  box-shadow: 0 15px 40px rgba(0,0,0,.15);
  display: none;
  z-index: 999;
}

.profile-dropdown.show { display: block; }

.profile-header {
  display: flex;
  gap: 12px;
  padding: 16px;
  border-bottom: 1px solid #eee;
}

.profile-header img {
  width: 48px;
  height: 48px;
  border-radius: 50%;
}

.profile-item {
  padding: 12px 16px;
  display: flex;
  gap: 10px;
  align-items: center;
  background: none;
  border: none;
  width: 100%;
  cursor: pointer;
  text-decoration: none;
  color: #2c3e50;
  font-size: 14px;
}

.profile-item:hover { background: #f4f7f9; }

.profile-item.logout {
  color: #e74c3c;
  font-weight: 600;
}

.upload-btn input { display: none; }

.divider {
  height: 1px;
  background: #eee;
  margin: 6px 0;
}
.avatar-wrapper {
  position: relative;
}

.avatar-wrapper img {
  width: 42px;
  height: 42px;
  border-radius: 50%;
  object-fit: cover;
  cursor: pointer;
  border: 2px solid #1abc9c;
}

/* dropdown */
.avatar-menu {
  position: absolute;
  right: 0;
  top: 120%;
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 10px 30px rgba(0,0,0,.15);
  display: none;
  overflow: hidden;
  z-index: 1000;
  min-width: 120px;
}

.avatar-menu.show {
  display: block;
}

.avatar-item {
  padding: 10px 14px;
  font-size: 14px;
  cursor: pointer;
  white-space: nowrap;
}

.avatar-item:hover {
  background: #f4f7f9;
}

.avatar-item.logout {
  color: #e74c3c;
  font-weight: 600;
}
.profile-menu {
  position: relative;
}

.profile-trigger img {
  width: 42px;
  height: 42px;
  border-radius: 50%;
  object-fit: cover;
  cursor: pointer;
  border: 2px solid #1abc9c;
}

/* dropdown */
.profile-dropdown {
  position: absolute;
  right: 0;
  top: 120%;
  width: 260px;
  background: #fff;
  border-radius: 14px;
  box-shadow: 0 12px 30px rgba(0,0,0,.15);
  display: none;
  z-index: 999;
}

.profile-dropdown.show {
  display: block;
}

/* header */
.profile-header {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px;
  border-bottom: 1px solid #e5e7eb;
}

.profile-header img {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  object-fit: cover;
}

/* menu item */
.profile-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 16px;
  font-size: 14px;
  cursor: pointer;
  color: #2c3e50;
  text-decoration: none;
  background: none;
  border: none;
  width: 100%;
  text-align: left;
}

.profile-item:hover {
  background: #f4f7f9;
}

.profile-item.logout {
  color: #e74c3c;
  font-weight: 600;
}

.divider {
  height: 1px;
  background: #e5e7eb;
  margin: 6px 0;
}
.status-active {
  color: #16a34a;
  font-weight: 600;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

.status-dot {
  width: 8px;
  height: 8px;
  background: #16a34a;
  border-radius: 50%;
  display: inline-block;
}
/* ===== USERS TABLE ===== */
#admin-users-table {
  width: 100%;
  border-collapse: collapse;
}

#admin-users-table th {
  background: #2c3e50;
  color: #fff;
  padding: 12px;
  text-align: left;
  font-weight: 600;
}

#admin-users-table td {
  padding: 12px;
  border-bottom: 1px solid #e5e7eb;
  vertical-align: middle;
}

/* ===== SELECT (บทบาท / สถานะ) ===== */
#admin-users-table select {
  padding: 6px 10px;
  border-radius: 8px;
  border: 1px solid #d1d5db;
  font-family: 'Kanit', sans-serif;
  background: #fff;
  cursor: pointer;
  transition: .2s;
}

#admin-users-table select:hover {
  border-color: #1abc9c;
}

#admin-users-table select:focus {
  outline: none;
  border-color: #1abc9c;
  box-shadow: 0 0 0 3px rgba(26,188,156,.25);
}

/* ===== STATUS COLOR ===== */
.status-active {
  color: #16a34a;
  font-weight: 600;
}

.status-inactive {
  color: #dc2626;
  font-weight: 600;
}

/* ===== DELETE BUTTON ===== */
.btn-delete {
  background: #fff;
  color: #dc2626;
  border: 1px solid #dc2626;
  padding: 6px 14px;
  border-radius: 20px;
  cursor: pointer;
  font-weight: 600;
  transition: .25s;
}

.btn-delete:hover {
  background: #dc2626;
  color: #fff;
}

/* ===== USER NAME ===== */
.user-name {
  font-weight: 600;
  color: #111827;
}

.user-email {
  color: #6b7280;
  font-size: 14px;
}
.role-select{
  padding:6px 10px;
  border-radius:6px;
  border:1px solid #d1d5db;
  font-family:'Kanit',sans-serif;
}

.status-active{
  color:#16a34a;
  font-weight:600;
}

.btn-delete{
  background:#ef4444;
  color:#fff;
  border:none;
  padding:5px 10px;
  border-radius:6px;
  cursor:pointer;
}
.btn-delete:hover{
  background:#dc2626;
}
.profile-menu{
  position: relative;
  z-index: 9999;
}

.profile-trigger img{
  width:42px;
  height:42px;
  border-radius:50%;
  border:2px solid #1abc9c;
  cursor:pointer;
  object-fit:cover;
}

.profile-dropdown{
  position:absolute;
  right:0;
  top:55px;
  width:220px;
  background:#fff;
  border-radius:12px;
  box-shadow:0 10px 30px rgba(0,0,0,.15);
  display:none;
  z-index:10000;
}

.profile-dropdown.show{
  display:block;
}
.profile-menu{
  position: relative;
  z-index: 99999; /* กันโดน element อื่นทับ */
}

.profile-trigger{
  cursor: pointer;
}

.profile-trigger img{
  pointer-events: auto;
}

  </style>
</head>
<body>
  <header>
    <div class="logo">
      <i class="fas fa-tools"></i>
      ระบบจัดการงานซ่อม
    </div>
    <nav class="nav-links">
      <a href="employee_dashboard.html" class="nav-link">
        <i class="fas fa-home"></i> หน้าหลัก
      </a>
      <a href="new_job.html" class="nav-link">
        <i class="fas fa-plus-circle"></i> รับเครื่องซ่อม
      </a>
      <a href="stock_management.html" class="nav-link">
        <i class="fas fa-box-open"></i> จัดการสต็อก
      </a>
      <a href="technician_jobs.html" class="nav-link">
        <i class="fas fa-tools"></i> งานของฉัน
      </a>
      <a href="reports.html" class="nav-link">
        <i class="fas fa-chart-line"></i> รายงาน
      </a>
      <a href="admin_dashboard.html" class="nav-link active">
        <i class="fas fa-user-shield"></i> ผู้ดูแลระบบ
      </a>
<div class="profile-menu" id="profileMenu">
  <div class="profile-trigger" onclick="toggleProfile()">
    <!-- รูปเล็ก (มุมขวาบน) -->
    <img
  id="profileAvatar"
  src=""
  alt="avatar"
  style="width:42px;height:42px;border-radius:50%;object-fit:cover;"
>

  </div>

  <div class="profile-dropdown" id="profileDropdown">
    <div class="profile-header">
      <!-- ✅ รูปใหญ่ใน dropdown -->
      <img
  id="profileAvatarLarge"
  src=""
  alt="avatar-large"
  style="width:60px;height:60px;border-radius:50%;object-fit:cover;"
>

      <div>
        <strong id="profileNameLarge">ผู้ใช้งาน</strong><br>
        <small id="profileRole">—</small>
      </div>
    </div>

    <label class="profile-item upload-btn">
      <i class="fas fa-camera"></i> เปลี่ยนรูปโปรไฟล์
      <input type="file" accept="image/*" onchange="uploadAvatar(event)">
    </label>

    <a class="profile-item" href="profile.html">
      <i class="fas fa-user"></i> ข้อมูลส่วนตัว
    </a>

    <a class="profile-item" href="change_password.html">
      <i class="fas fa-lock"></i> เปลี่ยนรหัสผ่าน
    </a>

    <a class="profile-item" href="repair_history.html">
      <i class="fas fa-history"></i> ประวัติการซ่อม
    </a>

    <div class="divider"></div>

    <button class="profile-item logout" onclick="logout()">
      <i class="fas fa-sign-out-alt"></i> ออกจากระบบ
    </button>
  </div>
</div>

    </nav>
    <div class="user-meta" id="user-meta">-</div>
  </header>

  <main class="container">
    <div class="page-header">
      <div>
        <h1 class="page-title">
          <i class="fas fa-user-shield"></i> แผงควบคุมผู้ดูแลระบบ
        </h1>
        <p class="page-subtitle">
          ตรวจสอบภาพรวมงานซ่อม จัดการบัญชีผู้ใช้ และบันทึกการใช้งานระบบ
        </p>
      </div>
      <div class="tag-admin">
        <i class="fas fa-lock"></i>
        สิทธิ์: ผู้ดูแลระบบ
      </div>
    </div>

    <!-- Cards summary -->
    <section class="dashboard-grid">
      <div class="card card-total">
        <div class="card-content">
          <p class="card-title">งานซ่อมทั้งหมด</p>
          <p class="card-number" id="card-total-jobs">0</p>
          <p class="card-note" id="card-total-note">-</p>
        </div>
        <i class="fas fa-clipboard-list card-icon"></i>
      </div>

      <div class="card card-new">
        <div class="card-content">
          <p class="card-title">คิวงานใหม่</p>
          <p class="card-number" id="card-new-jobs">0</p>
          <p class="card-note">รอจัดการ / มอบหมายงาน</p>
        </div>
        <i class="fas fa-plus-square card-icon"></i>
      </div>

      <div class="card card-progress">
        <div class="card-content">
          <p class="card-title">กำลังดำเนินการ / รออะไหล่</p>
          <p class="card-number" id="card-progress-jobs">0</p>
          <p class="card-note">ดูภาระงานช่างในปัจจุบัน</p>
        </div>
        <i class="fas fa-wrench card-icon"></i>
      </div>

      <div class="card card-completed">
        <div class="card-content">
          <p class="card-title">งานที่เสร็จสิ้น</p>
          <p class="card-number" id="card-completed-jobs">0</p>
          <p class="card-note">รวมงานที่ซ่อมเสร็จทั้งหมด</p>
        </div>
        <i class="fas fa-check-circle card-icon"></i>
      </div>

      <div class="card card-users">
        <div class="card-content">
          <p class="card-title">จำนวนผู้ใช้งานระบบ</p>
          <p class="card-number" id="card-users-count">0</p>
          <p class="card-note" id="card-users-note">-</p>
        </div>
        <i class="fas fa-users-cog card-icon"></i>
      </div>
    </section>

    <!-- 2 panels: jobs + users -->
    <section class="grid-2col">
      <!-- Jobs panel -->
      <div class="panel">
        <div class="panel-header">
          <div>
            <h2 class="panel-title">
              <i class="fas fa-clipboard-list"></i> งานซ่อมล่าสุด
            </h2>
            <p class="panel-subtitle">รายการงานซ่อม 10 งานล่าสุดในระบบ</p>
          </div>
          <span class="badge-pill">
            <i class="fas fa-info-circle"></i>
            ดึงจาก mockJobs (localStorage)
          </span>
        </div>
        <div class="table-wrapper">
          <table class="styled-table" id="admin-jobs-table">
            <thead>
              <tr>
                <th>รหัสงาน</th>
                <th>ลูกค้า</th>
                <th>อุปกรณ์</th>
                <th>สถานะ</th>
                <th>ช่างผู้รับผิดชอบ</th>
                <th>วันที่รับ</th>
              </tr>
            </thead>
            <tbody>
              <!-- JS เติม -->
            </tbody>
          </table>
        </div>
        <div id="jobs-empty" class="empty-text" style="display:none;">
          <i class="fas fa-box-open"></i> ยังไม่มีข้อมูลงานซ่อมในระบบ
        </div>
      </div>

      <!-- Users panel -->
     <div class="panel">
  <div class="panel-header">
    <div>
      <h2 class="panel-title">
        <i class="fas fa-users-cog"></i> จัดการบัญชีผู้ใช้
      </h2>
      <p class="panel-subtitle">
        เพิ่มพนักงาน / ช่าง และกำหนดสิทธิ์การใช้งานระบบ
      </p>
    </div>
  </div>

  <!-- เพิ่มผู้ใช้ -->
  <div class="add-user-card">
    <h3><i class="fas fa-user-plus"></i> เพิ่มผู้ใช้ใหม่</h3>

    <div class="add-user-grid">
      <input type="text" id="new-user-firstname" placeholder="ชื่อจริง" />
      <input type="text" id="new-user-lastname" placeholder="นามสกุล" />
      <input type="email" id="new-user-email" placeholder="อีเมล (ใช้เข้าสู่ระบบ)" />
      <input type="password"id="new-user-password"placeholder="รหัสผ่านเริ่มต้น" />

      <select id="new-user-role">
        <option value="tech">ช่างซ่อม</option>
        <option value="staff">พนักงานหน้าร้าน</option>
        <option value="admin">ผู้ดูแลระบบ</option>
      </select>

      <button type="button" class="btn-add-user" id="btn-add-user">
        <i class="fas fa-user-plus"></i> เพิ่มผู้ใช้
      </button>
    </div>

    <p class="hint-text">
      ระบบจะสร้างรหัสผ่านชั่วคราว และบังคับให้ผู้ใช้เปลี่ยนรหัสผ่านเมื่อเข้าสู่ระบบครั้งแรก
    </p>
  </div>

  <!-- ตารางผู้ใช้ -->
  <div class="table-wrapper">
    <table class="styled-table" id="admin-users-table">
      <thead>
        <tr>
          <th>ชื่อผู้ใช้</th>
          <th>อีเมล</th>
          <th>บทบาท</th>
          <th>สถานะ</th>
          <th>จัดการ</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="users-empty" class="empty-text" style="display:none;">
    <i class="fas fa-user-slash"></i> ยังไม่มีข้อมูลผู้ใช้ในระบบ
  </div>
</div>

<script>
/* ==================================================
   CONFIG
================================================== */
const API_BASE = "/api";
const token    = localStorage.getItem("token");
const role     = localStorage.getItem("role");
const userId   = localStorage.getItem("userId");
const userName = localStorage.getItem("userName");

/* ==================================================
   AUTH GUARD
================================================== */
if (!token || role !== "admin") {
  alert("หน้านี้สำหรับผู้ดูแลระบบเท่านั้น");
  localStorage.clear();
  location.href = "login.html";
}

/* ==================================================
   SAFE SET
================================================== */
function safeSet(id, value) {
  const el = document.getElementById(id);
  if (el) el.textContent = value;
}

safeSet("user-meta", `${userName || "Admin"} (ผู้ดูแลระบบ)`);

/* ==================================================
   API FETCH
================================================== */
async function apiFetch(path, options = {}) {
  const res = await fetch(API_BASE + path, {
    headers: {
      Authorization: `Bearer ${token}`,
      ...(options.body ? {} : { "Content-Type": "application/json" })
    },
    ...options
  });

  if (res.status === 401 || res.status === 403) {
    alert("Session หมดอายุ");
    localStorage.clear();
    location.href = "login.html";
    return null;
  }

  return res.ok ? res.json() : null;
}

/* ==================================================
   LOAD PROFILE
================================================== */
async function loadProfile() {
  if (!userId) return;

  const user = await apiFetch(`/employees/${userId}/profile`);
  if (!user) return;

  const avatar = user.avatar || "/uploads/profile/default.jpg";

  const img1 = document.getElementById("profileAvatar");
  const img2 = document.getElementById("profileAvatarLarge");

  if (img1) img1.src = avatar;
  if (img2) img2.src = avatar;

  localStorage.setItem("avatar", avatar);
}

/* ==================================================
   LOAD DATA
================================================== */
async function loadJobs() {
  return (await apiFetch("/jobs")) || [];
}

async function loadUsers() {
  return (await apiFetch("/employees")) || [];
}

/* ==================================================
   UPDATE DASHBOARD CARDS
================================================== */
function updateCards(jobs, users) {
  safeSet("card-total-jobs", jobs.length);
  safeSet("card-new-jobs", jobs.filter(j => j.status === "รับเครื่อง").length);
  safeSet(
    "card-progress-jobs",
    jobs.filter(j => ["กำลังซ่อม", "รออะไหล่"].includes(j.status)).length
  );
  safeSet("card-completed-jobs", jobs.filter(j => j.status === "ซ่อมเสร็จ").length);
  safeSet("card-users-count", users.length);
}

/* ==================================================
   RENDER JOBS TABLE
================================================== */
function renderJobsTable(jobs) {
  const tbody = document.querySelector("#admin-jobs-table tbody");

  if (!tbody) return;

  tbody.innerHTML = "";

  if (!jobs.length) {
    tbody.innerHTML = `<tr><td colspan="6">ไม่มีข้อมูลงาน</td></tr>`;
    return;
  }


  jobs.slice(0, 10).forEach(j => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${j.receiptNumber || "-"}</td>
      <td>${j.customerName || "-"}</td>
      <td>${j.deviceType || ""} ${j.deviceModel || ""}</td>
      <td>${j.status}</td>
      <td>${j.assignedTo?.firstName || "-"}</td>
      <td>${j.receivedDate
        ? new Date(j.receivedDate).toLocaleDateString("th-TH")
        : "-"}</td>
    `;
    tbody.appendChild(tr);
  });
}

/* ==================================================
   RENDER USERS TABLE
================================================== */
function renderUsersTable(users) {
  const tbody = document.querySelector("#admin-users-table tbody");

  if (!tbody) return;

  tbody.innerHTML = "";

  if (!users.length) {
    tbody.innerHTML = `<tr><td colspan="5">ไม่มีผู้ใช้</td></tr>`;
    return;
  }


  users.forEach(u => {
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${u.firstName} ${u.lastName}</td>
      <td>${u.email}</td>

      <td>
        <select onchange="updateUserRole('${u._id}', this.value)">
          <option value="admin" ${u.role==="admin"?"selected":""}>ผู้ดูแลระบบ</option>
          <option value="staff" ${u.role==="staff"?"selected":""}>พนักงาน</option>
          <option value="tech" ${u.role==="tech"?"selected":""}>ช่าง</option>
        </select>
      </td>
      <td>
        <span class="status-active">
          <span class="status-dot"></span> ออนไลน์
        </span>
      <td>
        <button onclick="deleteUser('${u._id}')">ลบ</button>
      </td>
    `;

    tbody.appendChild(tr);
  });
}

/* ==================================================
   UPDATE USER ROLE
================================================== */
async function updateUserRole(id, role) {
  if (!confirm("ต้องการเปลี่ยนสิทธิ์ผู้ใช้นี้หรือไม่?")) return;

  const res = await apiFetch(`/employees/${id}`, {
    method: "PUT",
    body: JSON.stringify({ role })
  });

  if (res) {
    alert("✅ เปลี่ยนสิทธิ์เรียบร้อย");
    init();
  }
}

/* ==================================================
   DELETE USER
================================================== */
async function deleteUser(id) {
  if (!confirm("ต้องการลบผู้ใช้นี้หรือไม่?")) return;

  const res = await apiFetch(`/employees/${id}`, { method: "DELETE" });
  if (res) {
    alert("ลบผู้ใช้เรียบร้อย");
    init();
  }
}

/* ==================================================
   AVATAR UPLOAD
================================================== */
async function uploadAvatar(event) {
  const file = event.target.files[0];
  if (!file) return;

  const fd = new FormData();
  fd.append("avatar", file);

  const res = await fetch("/api/employees/profile/avatar", {
    method: "POST",
    headers: {
      Authorization: `Bearer ${token}`
    },
    body: fd
  });

  const data = await res.json();

  if (!res.ok) {
    alert(data.message || "อัปโหลดไม่สำเร็จ");
    return;
  }

  document.getElementById("profileAvatar").src = data.avatar;
  document.getElementById("profileAvatarLarge").src = data.avatar;

  localStorage.setItem("avatar", data.avatar);
  alert("✅ เปลี่ยนรูปโปรไฟล์เรียบร้อย");
}

/* ==================================================
   INIT
================================================== */
async function init() {
  const [jobs, users] = await Promise.all([
    loadJobs(),
    loadUsers()
  ]);

  updateCards(jobs, users);
  renderJobsTable(jobs);
  renderUsersTable(users);
}

/* ==================================================
   LOGOUT
================================================== */
function logout() {
  localStorage.clear();
  location.href = "login.html";
}

/* ==================================================
   ON LOAD
================================================== */
document.addEventListener("DOMContentLoaded", () => {
  loadProfile();
  init();
});
document.getElementById("btn-add-user")?.addEventListener("click", async () => {
  const firstName = document.getElementById("new-user-firstname").value.trim();
  const lastName  = document.getElementById("new-user-lastname").value.trim();
  const email     = document.getElementById("new-user-email").value.trim();
  const password  = document.getElementById("new-user-password").value.trim();
  const role      = document.getElementById("new-user-role").value;

  if (!firstName || !lastName || !email || !password || !role) {
    alert("กรุณากรอกข้อมูลให้ครบ");
    return;
  }

  const res = await fetch("/api/employees", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${token}`
    },
    body: JSON.stringify({
      firstName,
      lastName,
      email,
      password,
      role
    })
  });

  const data = await res.json();

  if (!res.ok) {
    alert(data.message || "เพิ่มผู้ใช้ไม่สำเร็จ");
    return;
  }

  alert("✅ เพิ่มผู้ใช้เรียบร้อย");

  // เคลียร์ฟอร์ม
  document.getElementById("new-user-firstname").value = "";
  document.getElementById("new-user-lastname").value = "";
  document.getElementById("new-user-email").value = "";
  document.getElementById("new-user-password").value = "";

  // โหลดตารางใหม่
  init();
});
function toggleProfile() {
  const dropdown = document.getElementById("profileDropdown");
  dropdown.classList.toggle("show");
}

document.addEventListener("click", (e) => {
  const trigger = document.querySelector(".profile-trigger");
  const dropdown = document.getElementById("profileDropdown");

  if (!trigger || !dropdown) return;

  if (!trigger.contains(e.target) && !dropdown.contains(e.target)) {
    dropdown.classList.remove("show");
  }
});
</script>


</body>
</html>

